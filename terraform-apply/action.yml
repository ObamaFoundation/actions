inputs:
  environment:
    description: "The environment path relative to the environments directory"
    required: true
  environments_dir:
    description: "Environments directory path"
    required: false
    default: "environments"
  artifact_id:
    description: "The artifact id to download"
    required: true

name: "Terraform Apply"
description: "Runs terraform apply using the plan generated by the terraform plan action"

runs:
  using: composite
  steps:
    - name: Download plan
      id: download
      uses: actions/download-artifact@v3
    - name: inspect ls
      shell: bash
      run: |
        ls -la
    - name: Check for Plan Artifact
      shell: bash
      id: check
      run: |
        if [[ -d ${{ inputs.artifact_id }} ]]; then
          echo "Plan artifact found. Moving it to the proper environment directory..."
          mv ${{ inputs.artifact_id }}/tfplan ${{ inputs.environments_dir }}/${{ inputs.environment }}/tfplan
          echo "run_apply=true" >> $GITHUB_OUTPUT
        else
          echo "No plan artifact found."
          echo "run_apply=false" >> $GITHUB_OUTPUT
        fi
    - uses: hashicorp/setup-terraform@v2
    - name: Terraform init
      if: steps.check.outputs.run_apply == 'true'
      shell: bash
      run: terraform -chdir=${{inputs.environments_dir}}/${{ inputs.environment }} init
    - name: Terraform apply
      if: steps.check.outputs.run_apply == 'true'
      id: apply
      shell: bash
      run: |
        terraform \
          -chdir=${{inputs.environments_dir}}/${{ inputs.environment }} \
          apply \
          -input=false \
          -lock-timeout=300s \
          -no-color \
          -auto-approve \
          tfplan
